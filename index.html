<?php
$botToken = '7873235362:AAFJp0ppDlYP1d_qBwT-R2kStFRgkGums94';

$channels = [
    [
        'id' => '@sinhlacartoon',
        'name' => 'Sinhala Cartoon',
        'logo' => 'https://i.ibb.co/WWj3LPFk/sinhlacartoon.jpg'
    ],
    [
        'id' => '@sl_bjs',
        'name' => 'SL BJs',
        'logo' => 'https://i.ibb.co/spCGHpyK/slbjs.jpg'
    ],
    [
        'id' => '@Reload_proofs',
        'name' => 'Reload Proofs',
        'logo' => 'https://via.placeholder.com/40?text=Reload+Proofs'
    ]
];

$channelIdsJson = json_encode(array_column($channels, 'id', 'name'));
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Telegram Membership Check</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1);}
    .channel { display: flex; align-items: center; margin-bottom: 15px; }
    .channel-logo { width: 40px; height: 40px; border-radius: 5px; margin-right: 10px; }
    .status { margin-left: auto; font-weight: bold; }
    .joined { color: green; }
    .error { color: red; }
    .check-button, .join-button, .visit-button {
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      color: white;
      background-color: #007bff;
      cursor: pointer;
    }
    .popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .popup.active { display: flex; }
    .popup-content { background: white; padding: 30px; border-radius: 10px; text-align: center; }
    .popup-icon { font-size: 30px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Telegram Membership Check</h2>
    <div id="channels">
      <?php foreach ($channels as $index => $channel): ?>
        <div class="channel" id="channel<?php echo $index + 1; ?>">
          <img src="<?php echo $channel['logo']; ?>" class="channel-logo" alt="<?php echo $channel['name']; ?>"/>
          <span><?php echo $channel['name']; ?></span>
          <span class="status" id="status-channel<?php echo $index + 1; ?>">pending...</span>
          <a href="https://t.me/<?php echo ltrim($channel['id'], '@'); ?>" class="join-button" id="join-channel<?php echo $index + 1; ?>" target="_blank">Join</a>
        </div>
      <?php endforeach; ?>
    </div>
    <button class="check-button" onclick="checkMembership()">Check Membership</button>
  </div>

  <div class="popup" id="popup">
    <div class="popup-content">
      <div class="popup-icon" id="popup-icon"><i class="fas fa-spinner fa-spin"></i></div>
      <h3 id="popup-header">Checking...</h3>
      <p id="popup-body">Please wait while we check your membership status.</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>

  <script>
    const botToken = "<?php echo $botToken ?>";
    const channels = <?php echo $channelIdsJson ?>;
    const username = new URLSearchParams(window.location.search).get("username") || "";

    function showPopup(header, body, icon) {
      document.getElementById("popup-header").innerText = header;
      document.getElementById("popup-body").innerText = body;
      document.getElementById("popup-icon").innerHTML = `<i class="fas ${icon}"></i>`;
      document.getElementById("popup").classList.add("active");
    }

    function closePopup() {
      document.getElementById("popup").classList.remove("active");
    }

    async function checkMembership() {
      if (!username) {
        showPopup("Error", "Username not provided in URL.", "fa-times-circle");
        return;
      }

      showPopup("Checking...", "Please wait while we check...", "fa-spinner fa-spin");

      let allJoined = true;
      const keys = Object.keys(channels);

      for (let i = 0; i < keys.length; i++) {
        const name = keys[i];
        const channel = channels[name];
        const statusElem = document.getElementById(`status-channel${i + 1}`);
        const joinButton = document.getElementById(`join-channel${i + 1}`);

        try {
          const res = await fetch(`https://api.telegram.org/bot${botToken}/getChatMember?chat_id=${channel}&user_id=${username}`);
          const data = await res.json();

          if (data.ok) {
            const status = data.result.status;
            if (['member', 'administrator', 'creator'].includes(status)) {
              statusElem.innerHTML = "✅ Joined";
              statusElem.className = "status joined";
              joinButton.textContent = "Visit";
              joinButton.className = "visit-button";
            } else {
              statusElem.innerHTML = "❌ Not Joined";
              statusElem.className = "status error";
              allJoined = false;
            }
          } else {
            statusElem.innerHTML = "❌ Not Joined";
            statusElem.className = "status error";
            allJoined = false;
          }
        } catch (err) {
          statusElem.innerHTML = "⚠️ Error";
          statusElem.className = "status error";
          allJoined = false;
        }
      }

      if (allJoined) {
        showPopup("Success", "You have joined all required channels!", "fa-check-circle");
      } else {
        showPopup("Incomplete", "Please join all required channels.", "fa-times-circle");
      }
    }
  </script>

  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>
